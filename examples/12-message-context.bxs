/**
 * Example 12: Message Context & Binding Parameters
 *
 * This example demonstrates using message context and binding parameters
 * to inject data into AI prompts - a "poor man's RAG" approach.
 *
 * We'll load customer data from a JSON file and use it to personalize
 * an AI conversation using both binding parameters and message context.
 */

println( "=".repeat( 80 ) )
println( "Example 12: Message Context & Binding Parameters" )
println( "=".repeat( 80 ) )
println( "" )

// Load customer database (JSON file simulating a database)
println( "ğŸ“‚ Loading customer database..." )
dbData = jsonDeserialize( fileRead( "./assets/customers.json" ) )
println( "âœ… Loaded #dbData.customers.len()# customers" )
println( "" )

// Look up a specific customer
targetCustomerId = "C001"
println( "ğŸ” Looking up customer: #targetCustomerId#" )

customer = dbData.customers.findFirst( c => c.id == targetCustomerId, {} )
println( "âœ… Found: #customer.name# (#customer.accountType#)" )
println( "" )

// Create an AI message with context and bindings
println( "ğŸ¯ Creating message with context and bindings..." )
println( "" )

// =============================================================== //
// =============================================================== //

message = aiMessage()
    .system(
        "You are an AI customer service agent.
        Use the customer data to personalize your response.
        Customer Context: ${context}"
    )
    .user( "Hi, I'm ${customerName}. I need help with my recent order. Can you check my account?" )
	// Inject customer data as context (complex structured data)
	.mergeContext( {
		"customer": customer,
		"recentActivity": customer.recentActivity,
		"companyPolicies": {
			"returnPolicy": dbData.productKnowledge.returnPolicy,
			"shippingInfo": dbData.productKnowledge.shippingInfo
		}
	} )
	// Add binding parameters (simple variable substitution)
	.bind({
    	"customerName": customer.name
	})

println( "ğŸ“¦ Injected Data:" )
println( "   - Context: Customer profile, recent activity, and policies" )
println( "   - Binding: customerName = '#customer.name#'" )
println( "" )

// Send to AI
println( "ğŸš€ Sending to AI..." )
response = aiChat( message )

println( "ğŸ¤– AI Response:" )
println( response )
println( "" )

println( "=".repeat( 80 ) )
println( "âœ¨ What happened:" )
println( "" )
println( "1ï¸âƒ£  Loaded customer data from JSON file (simulated database)" )
println( "2ï¸âƒ£  Used .mergeContext() to inject structured data as ${context}" )
println( "3ï¸âƒ£  Used .bind() for simple variable substitution (${customerName})" )
println( "4ï¸âƒ£  AI received personalized context and responded accordingly" )
println( "" )
println( "ğŸ“š Learn more: https://ai.ortusbooks.com/main-components/messages/message-context" )
println( "=".repeat( 80 ) )
